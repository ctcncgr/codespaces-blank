<!DOCTYPE html>

<html>

  <head>
    <meta charset="utf-8" />
    <title>LIS Web-Components - &lt;lis-gene-search-element&gt;</title>
    <!-- CSS framework -->
    <link rel="stylesheet" type="text/css" href="../node_modules/uikit/dist/css/uikit.min.css">
    <script src="../node_modules/uikit/dist/js/uikit.min.js"></script>
    <!-- web components polyfills -->
    <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../node_modules/lit/polyfill-support.js"></script>
    <!-- GraphQL -->
    <script type="text/javascript" src="./graphql.js"></script>
    <script type="text/javascript" src="./linkout.js"></script>
    <!-- web components -->
    <script type="module" src="../dist/index.js"></script>
  </head>

  <body>

    <div class="uk-container">
      <h1>&lt;lis-gene-search-element&gt; with &lt;lis-linkout-search-element&gt;</h1>
      <p>
        The <code>&lt;lis-gene-search-element&gt;</code> provides a form for performing gene searches and displays the results in a paginated table.
        The search is performed using an external function provided to the component when it is added to the page.
        In this example, the component performs a path query search for legume genes using the LIS GraphQL API query <code>genes</code>.
        See the source code for details.
        Note that the form's input and page values are kept up to date in the URL query string parameters.
        This allows users to share specific pages from a search via the URL and for the search history to be navigated via the Web browser's forward and back buttons.
        If the query string parameters are present when the component loads then a search will be automatically performed with the query string parameter values.
      </p>
      <p>
        To further demonstrate how to interact with multiple components, the <code>&lt;lis-linkout-search-element&gt;</code> <code>queryString</code> parameter is populated on button click inside of an instance of <code>&lt;lis-modal-element&gt;</code>using the <code>name</code> attribute from <code>data.genes</code>. This button also shows the modal using the UIkit API through <code>uk-toggle</code>.
      </p>
      <hr>

      <!-- the custom gene search element -->
      <lis-gene-search-element id="gene-search"></lis-gene-search-element>
      <a class="uk-button uk-button-default" href="#test-linkout" type="submit" uk-toggle>Open</a>
      <lis-modal-element modalId="test-linkout">
        <lis-linkout-search-element
          id="linkout-search">
        </lis-linkout-search-element>
      </lis-modal-element>
    </div>

    <!-- set the search function by property because functions can't be set as attributes -->
    <script type="text/javascript">

      // gene description search query for the LIS GraphQL API
      const geneQuery = `
      query Query($description: String!, $start: Int, $size: Int) {
        genes(description: $description, start: $start, size: $size) {
          name
          description
        }
      }
      `;
      
      // the search function given to the LIS gene search Web Component
      function getGenes(searchData, page, {abortSignal}) {
          const description = searchData['query'];
          const pageSize = 10;
          const start = (page-1)*pageSize;
          // pageSize+1 because we want to see if there's a "next" page
          const variables = {description: description, start: start, size: pageSize+1};
          // returns a Promise that resolves to an array of Gene objects the gene search
          // Web Component knows how to parse: {name: string, description: string}[]
          return graphqlQuery(uri, geneQuery, variables, abortSignal)
              .then(({data}) => {
                  // compute if there's a next page
                  const hasNext = pageSize+1 === data.genes.length;
                  // remove the lookahead result
                  if (hasNext) data.genes.pop();
                  console.log(data.genes);
                  const clickableGenes = data.genes.map((d) => ({name: `<a class="uk-button uk-button-default" href="#test-linkout" type="submit" uk-toggle id="${d.name}">${d.name}</a>`, 
                                                                 description: d.description}));
                  // construct the expected paginated results object
                  const paginatedResults = {
                      hasNext,
                      results: clickableGenes,
                  };
                  return paginatedResults;
              });
      }

      // the linkout function to give to the linkout search component
      function getLinkouts(linkoutData){
          const domain = 'https://cicer.legumeinfo.org';
          // returns a function with a promise to be used by the linkout search component
	  // to populate the simple table element
          return queryLinkouts(domain, linkoutData);
      }

      // Get the components and attach their search functions
      const geneSearchElement = document.getElementById('gene-search');
      const linkoutSearchElement = document.getElementById('linkout-search');
      geneSearchElement.searchFunction = getGenes;
      linkoutSearchElement.linkoutFunction = getLinkouts;

      document.addEventListener('click', function (event) {
	// If the clicked element doesn't have the right selector, bail
	if (!event.target.matches('.uk-button')) return;
	// Don't follow the link
	event.preventDefault();
	// set the queryString to fire the linkout search component
        linkoutSearchElement.queryString = `genes=${event.target.id}`;
      }, false);

    </script>

  </body>

</html>
